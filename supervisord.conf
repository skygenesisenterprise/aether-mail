[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor/

# ---------------------------
# Backend Rust API
# ---------------------------
[program:backend]
command=/app/backend/api
directory=/app/backend
user=aethermail
autostart=true
autorestart=true
startretries=3
startsecs=10
stdout_logfile=/var/log/supervisor/backend.log
stderr_logfile=/var/log/supervisor/backend.err
environment=USER=aethermail,HOME=/app/backend

# ---------------------------
# Nginx Frontend
# ---------------------------
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
user=root
autostart=true
autorestart=true
startretries=3
startsecs=5
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx.err

# ---------------------------
# Health Check
# ---------------------------
[program:health-check]
command=/bin/bash -c "while true; do curl -f http://localhost:80/health || exit 1; sleep 30; done"
user=aethermail
autostart=true
autorestart=true
startretries=3
startsecs=30
stdout_logfile=/var/log/supervisor/health-check.log
stderr_logfile=/var/log/supervisor/health-check.err